---
title: "ICP2.0_2024BirdCountAnalysis"
author: "Kylie Blake"
date: "2025-03-05"
output: html_document:
  md_doucment:
    variant: gfm
---

Final project - you are to use your data from your PhD or Master's research or data from a paper you want to reproduce and write a reproducible workflow using these data. 

History of evidence of integration with version control - 10 points 
Creation of figures that are manuscript-ready - 25 points
Use of reproducible and efficient coding techniques like functions, self-checks, R markdown, loops, and data simulation. - 50 points 
Must have a README file - 10 points 
Must be in an R project - 5 points 
I or someone else must be able to download your project. run the code, have it make sense, and reproduce it! - 25 points

##Load in Packages and Excel Workbooks

```{r}
#Load in packages
library(readxl)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(ggrepel)
#library(sf)
#library(rnaturalearth)
library(dplyr)
library(devtools)
library(tidyr)
library(grafify)
library(hms)
library(lubridate) # For handling dates
library(chngpt)    # For threshold regression
```

##Load in Excel Workbooks and Tidy the Data

```{r}
#Load in necessary workboooks
surveys <- read_excel("FinalProject\\birdsICP2.xlsx",sheet = "surveyLevel")  # Data containing survey-level information
individuals <- read_excel("FinalProject\\birdsICP2.xlsx",sheet = "individualLevel") #Data containing individual-level information
points <- read_excel("FinalProject\\vegICP2.xlsx",sheet = "pointLevel") #Data containing point-level information
detections <- read_excel("FinalProject\\birdsICP2.xlsx",sheet = "detectionLevel") #Data containing detection-level information

detections = detections[, -1] # remove redundant data sheet number
 
# Reshape individuals and detections for later analysis
birds = individuals %>%
  left_join(detections, by = "individualId") %>%
  pivot_wider(names_from = interval, values_from = distanceIcp2)
```

###Tidy Data
Combining 
1. Date and Time Conversion: It converts date and time columns into a single DateTime column, computes hours since midnight, and scales the time of day. Filtering: It filters out surveys conducted before a specific cutoff date (May 13th, 2024).Survey Labeling: It assigns survey labels based on the chronological order within each pointId2.Data Cleaning: It converts 'FLUSHED' values in the 'Time of 1st Detection' column to -1 so the column is read as an integer string.
2. Merge the surveyLevel (bird data) and pointLevel (vegetation data) together by pointId2. Each point had a unique pointId2 that links bird and vegetation data together.
3. Add the individual level species data to the merged data from step 1. merge them by dataSheetNum, which links the Survey Level to individual level. 

```{r}
# Convert date and time columns to single Date Time Column

# Step 1: Convert Date from character to Date format
surveys$date <- as.Date(surveys$date, format = "%d %b %Y")
 
# Convert startTime to time-only format and compute hours since midnight
surveys <- surveys %>%
  mutate(
    timeOnly = format(as.POSIXct(startTime, format="%Y-%m-%d %H:%M:%S"), "%H:%M:%S"),
    hrsSinceMidnight = hour(as.POSIXct(startTime, format="%Y-%m-%d %H:%M:%S")) +
      minute(as.POSIXct(startTime, format="%Y-%m-%d %H:%M:%S")) / 60 +
      second(as.POSIXct(startTime, format="%Y-%m-%d %H:%M:%S")) / 3600,
    scaledTimeOfDay = scale(hrsSinceMidnight, center = TRUE, scale = TRUE)[,1] # Extract numeric value
  )
 
# Filter out surveys before the breeding season cutoff (May 13th, 2024)
cutoff_date <- as.POSIXct("2024-05-13", format = "%Y-%m-%d") # Set cutoff date
surveys <- surveys %>% filter(date > cutoff_date)  # Keep only surveys after the cutoff
 
# Filter the data frame to only include rows where DateTime is later than May 13th, 2024
surveys <- surveys %>%
  filter(date > cutoff_date)

 
# Create a 'DayOfYear' column in surveys for later use because time objects don't work in occu() function
surveys$DayOfYear <- yday(surveys$date)
#-------------------------------------------------

#Step 2: Assign survey labels based on the chronological order within each pointId2 (i.e. survey1, survey2, survey3, & survey4)**

surveys$survey <- NA  # Initialize a 'survey' column
surveys <- surveys %>%
  group_by(pointId2) %>%  # Group by 'pointId2'
  arrange(date, .by_group = TRUE) %>%  # Sort each group by 'Datetime' ##### <---- NEED TO RE-CREATE A DATETIME OBJECT PRIOR TO THIS
  mutate(survey = paste0("survey", row_number())) %>%  # Assign survey labels
  ungroup()  # Ungroup the data

#-------------------------------------------------------------
#Step 3: Assign -1 to 'FLUSHED' values in 'Time of 1st Detection' to allow for conversion to numeric data
birds$timeOfFirstDet[birds$timeOfFirstDet == "FLUSHED"] <- -1
birds$timeOfFirstDet <- as.integer(birds$timeOfFirstDet)  # Convert to integer
class(birds$timeOfFirstDet)  # Check the class of the column
table(birds$timeOfFirstDet)  # View frequency table of values

```


```{r}
#Merge pointLevel covariates into surveyLevel by matching column 'pointId2'
merged_data <- surveys %>%
  left_join(points, by = "pointId2")  # Perform a left join to preserve all rows in surveyLevel
  #this is saying merge surveyLevel with PointLevel so data is set up surveyLevel|pointLevel and merged from pointId2 on 

#Merge individualLevel data into merged_data by matching on 'dataSheetNum'
merged_data <- merged_data %>%
  left_join(individuals, by = "dataSheetNum") #Perform a left join to preserve all rows in surveyLevel

# Merge 'surveys' and 'birds' data sets using the 'dataSheetNum' column
merged_data <- left_join(surveys, birds, by = "dataSheetNum")
# Merge merged data and 'points' using 'pointId2' column
merged_data = merged_data[,-2] # removes redundant pointID1, since it's also in points
merged_data <- left_join(points, merged_data, by = "pointId2")
```


#Species Specific Exploration
Investigating the wildlife management areas and landcover types the focal species are on. 

**INCLUDE HERE A TABLE OF THE LANDCOVEWR TYPES**

```{r}
#Function to calculate focal species (Northern Bobwhite, Bachman's sparrow, Prairie Warbler, and American Kestrel)
count_species_occurrences <- function(data, species_name, variable) {
  # Filter data for the specified species
  filtered_data <- data %>%
    filter(species == species_name)
  
  # Group data by the specified variables and count occurrences
  counts <- filtered_data %>%
    group_by(across(all_of(variable))) %>%
    summarise(count = n())
  
  # Print the counts
  print(counts)
  
  return(counts)
}

##################### Northern Bobwhite (NOBO) ##########################
# Count occurrences of species "NOBO" grouped by WMA
nobo_counts_wma <- count_species_occurrences(merged_data, "NOBO", c("wma"))

# Count occurrences of species "NOBO" grouped by landcover
nobo_counts_landcover <- count_species_occurrences(merged_data, "NOBO", c("landcover"))

# Count occurrences of species "NOBO" grouped by both WMA and landcover
nobo_counts_wma_landcover <- count_species_occurrences(merged_data, "NOBO", c("wma", "landcover"))

##################### Bachman's Sparrow (BACS) ##########################
bacs_counts_wma <- count_species_occurrences(merged_data, "BACS", c("wma"))

# Count occurrences of species "bacs" grouped by landcover
bacs_counts_landcover <- count_species_occurrences(merged_data, "BACS", c("landcover"))

# Count occurrences of species "NOBO" grouped by both WMA and landcover
bacs_counts_wma_landcover <- count_species_occurrences(merged_data, "BACS", c("wma", "landcover"))

##################### Prairie Warbler (PRAW) ##########################
praw_counts_wma <- count_species_occurrences(merged_data, "PRAW", c("wma"))

# Count occurrences of species "bacs" grouped by landcover
praw_counts_landcover <- count_species_occurrences(merged_data, "PRAW", c("landcover"))

# Count occurrences of species "NOBO" grouped by both WMA and landcover
praw_counts_wma_landcover <- count_species_occurrences(merged_data, "PRAW", c("wma", "landcover"))

##################### American Kestrel (AMKE) ##########################
amke_counts_wma <- count_species_occurrences(merged_data, "AMKE", c("wma"))

#Since there is only one American kestrel on one of the wildlife management areas, there will be no further analysis of this focal species. 
```


## Target Species

###Step 1. Explore species-level data 

```{r}


################ WMA ##################
targetspecies_counts_wma <- merged_data %>% 
  filter(species %in% c("NOBO", "BACS", "AMKE","PRAW")) %>% 
  filter(wma == "PR") %>% 
  group_by(species, wma) %>% 
  summarise(count = n(),.groups= "drop")

#Graph Form - Species by WMA
ggplot() +
  geom_point(
    data = targetspecies_counts_wma,
    aes(x = species, y = count, color = wma),
    shape=20,
    size = 5)

################ Landcover ##################

#Step 1: Make a table of landcover target specis used in PR
targetspecies_counts_landcover <- merged_data %>% 
  filter(species %in% c("NOBO", "BACS", "AMKE","PRAW")) %>% 
  filter(wma == "PR") %>%
  group_by(species, landcover) %>% 
  summarise(count = n(),.groups= "drop")


library(plotly)
#Graph Form - Species by Landcover

target_landcovergraph <-  ggplot() +
  geom_point(
    data = targetspecies_counts_landcover,
    aes(x = species, y = count, color = landcover),
    shape=20,
    size = 5)+
  labs(
    title = "Target Species Count on Categorized Landcover Types at Perdido River WMA"
  )
ggplotly(target_landcovergraph)
#Detection per number of site in that category

################ WMA and Landcover ##################
targetspecies_counts_wma_landcover <- merged_data %>% 
  filter(species %in% c("NOBO", "BACS", "AMKE","PRAW")) %>% #This %in% ensures that only rows where the species column matches any of the values ("NOBO", "BACS", "AMKE") are kept.
  group_by(species, wma, landcover) %>% 
  summarise(count = n(),.groups= "drop")

print(targetspecies_counts_wma_landcover)
```

### Step 2. Exploring Landcover Types at Perdido River 

#### Looking for Target Species presence across landscape

#### NOBO

```{r}

#################################DATA MANIPULATION##########################################

filtered_data <- merged_data %>%
  filter(wma == "PR")

# Calculate the total number of NOBO seen at each landcover type
nobo_counts <- filtered_data %>%
  filter(species == "NOBO") %>%
  group_by(landcover) %>%
  summarise(total_nobo = n())
nobo_counts

# Calculate the total number of distinct pointID2s for each landcover type
total_points <- filtered_data %>%
  group_by(landcover) %>%
  summarise(total_points = n_distinct(pointId2))
total_points

# Calculate the number of distinct pointID2s where NOBO were seen for each landcover type
nobo_points <- filtered_data %>%
  filter(species == "NOBO") %>%
  group_by(landcover) %>%
  summarise(nobo_points = n_distinct(pointId2))
nobo_points

# Join the two data frames and calculate the proportion
result <- total_points %>%
  left_join(nobo_counts, by = "landcover") %>%
  left_join(nobo_points, by = "landcover") %>% 
  mutate(
    proportion_points_with_nobo = nobo_points / total_points,
    average_nobo_per_point_with_nobo = total_nobo / nobo_points) %>% 
  mutate(across(c(total_points, total_nobo, nobo_points, proportion_points_with_nobo, average_nobo_per_point_with_nobo), ~ replace_na(., 0)))

#################################FIGURES##########################################

#Figure for proportion of landcover points with NOBO
# ggplot(result, aes(x = landcover, y = proportion_points_with_nobo, fill = landcover)) +
#   geom_bar(stat = "identity") +
#   labs(title = "Proportion of Points with NOBO Seen at Each Landcover Type",
#        x = "Landcover Type",
#        y = "Proportion of Points with NOBO") +
#   #scale_fill_grafify(palette = "fishy", labels = c("Mixed Pine/Hardwood (MPH)", "Openings (OP)", "Disturbed Areas (DA)","Even-Aged Pine (EAP)", "Uneven-aged Forested Wetland (UAW)", "Young Pine (YP)", "Unknown", "Uneven-aged Pine (UAP)")) +
# # scale_x_discrete(labels = c("MPH","OP","DA", "EAP","UAW", "YP", "Unknown", "UAP")) +
#   theme_minimal() +
#   theme(axis.text.x = element_text(angle = 45, hjust=1))

library(cowplot)

fig_NOBO <-  
  ggplot(result, aes(x = landcover)) +
  geom_bar(aes(y = total_points, fill = "Total Points"), stat = "identity", position = "dodge") +
  geom_bar(aes(y = nobo_points, fill = "Points with Target Species"), stat = "identity", position = "dodge") +
  labs(title = "Northern Bobwhite",
       x = "",
       y = "") +
  scale_fill_manual(name = "Legend",
                    values = c("Total Points" = "#F6A600", "Points with Target Species" = "darkblue"),
                    labels = c("Points with Target Species", "Total Points")) +
  #scale_x_discrete(labels = c("MPH" = "Mixed Pine/Hardwood", "OP" = "Openings", "DA" = "Disturbed Areas", "EAP" = "Even-Aged Pine", "UAW" = "Uneven-aged Forested Wetland", "YP" = "Young Pine", "NULL" = "Unknown", "UAP" = "Uneven-aged Pine", "EAW" = "Even-aged Wetland", "UAH" = "Uneven-aged Hardwood", "YH" = "Young Hardwood")) +
  theme_cowplot() +
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_blank())

#OK now do this for BACS and PRAW and then maybe a combined by species figure 
#maybe do a gg arrange or facet wrap by speciess
```

### BACS

```{r}

######################################## DATA MANIPULATION ##########################################

# Calculate the total number of BACS seen at each landcover type
BACS_counts <- filtered_data %>%
  filter(species == "BACS") %>%
  group_by(landcover) %>%
  summarise(total_BACS = n())
BACS_counts


# Calculate the number of distinct pointID2s where BACS were seen for each landcover type
BACS_points <- filtered_data %>%
  filter(species == "BACS") %>%
  group_by(landcover) %>%
  summarise(BACS_points = n_distinct(pointId2))
BACS_points

# Join the two data frames and calculate the proportion
result <- total_points %>%
  left_join(BACS_counts, by = "landcover") %>%
  left_join(BACS_points, by = "landcover") %>% 
  mutate(
    proportion_points_with_BACS = BACS_points / total_points,
    average_BACS_per_point_with_BACS = total_BACS / BACS_points) %>% 
  mutate(across(c(total_points, total_BACS, BACS_points, proportion_points_with_BACS, average_BACS_per_point_with_BACS), ~ replace_na(., 0)))

#################################FIGURES##########################################

#Figure for proportion of landcover points with BACS
# ggplot(result, aes(x = landcover, y = proportion_points_with_BACS, fill = landcover)) +
#   geom_bar(stat = "identity") +
#   labs(title = "Proportion of Points with BACS Seen at Each Landcover Type",
#        x = "Landcover Type",
#        y = "Proportion of Points with BACS") +
#   #scale_fill_grafify(palette = "fishy", labels = c("Mixed Pine/Hardwood (MPH)", "Openings (OP)", "Disturbed Areas (DA)","Even-Aged Pine (EAP)", "Uneven-aged Forested Wetland (UAW)", "Young Pine (YP)", "Unknown", "Uneven-aged Pine (UAP)")) +
# # scale_x_discrete(labels = c("MPH","OP","DA", "EAP","UAW", "YP", "Unknown", "UAP")) +
#   theme_minimal() +
#   theme(axis.text.x = element_text(angle = 45, hjust=1))

fig_BACS <-  
 ggplot(result, aes(x = landcover)) +
  geom_bar(aes(y = total_points, fill = "Total Points"), stat = "identity", position = "dodge") +
  geom_bar(aes(y = BACS_points, fill = "Points with Target Species"), stat = "identity", position = "dodge") +
  labs(title = "Bachman's Sparrow",
       x = "",
       y = "") +
  scale_fill_manual(name = "Legend",
                    values = c("Total Points" = "#F6A600", "Points with Target Species" = "darkblue"),
                    labels = c("Points with Target Species", "Total Points")) +
  #scale_x_discrete(labels = c("MPH" = "Mixed Pine/Hardwood", "OP" = "Openings", "DA" = "Disturbed Areas", "EAP" = "Even-Aged Pine", "UAW" = "Uneven-aged Forested Wetland", "YP" = "Young Pine", "NULL" = "Unknown", "UAP" = "Uneven-aged Pine", "EAW" = "Even-aged Wetland", "UAH" = "Uneven-aged Hardwood", "YH" = "Young Hardwood")) +
  theme_cowplot() +
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_blank())

```

###PRAW

```{r}

################################## DATA MANIPULATION #########################################
filtered_data <- merged_data %>%
  filter(wma == "PR")

# Calculate the total number of PRAW seen at each landcover type
PRAW_counts <- filtered_data %>%
  filter(species == "PRAW") %>%
  group_by(landcover) %>%
  summarise(total_PRAW = n())
PRAW_counts


# Calculate the number of distinct pointID2s where PRAW were seen for each landcover type
PRAW_points <- filtered_data %>%
  filter(species == "PRAW") %>%
  group_by(landcover) %>%
  summarise(PRAW_points = n_distinct(pointId2))
PRAW_points

# Join the two data frames and calculate the proportion
result <- total_points %>%
  left_join(PRAW_counts, by = "landcover") %>%
  left_join(PRAW_points, by = "landcover") %>% 
  mutate(
    proportion_points_with_PRAW = PRAW_points / total_points,
    average_PRAW_per_point_with_PRAW = total_PRAW / PRAW_points) %>% 
  mutate(across(c(total_points, total_PRAW, PRAW_points, proportion_points_with_PRAW, average_PRAW_per_point_with_PRAW), ~ replace_na(., 0)))

#################################FIGURES##########################################

#Figure for proportion of landcover points with NOBO
# ggplot(result, aes(x = landcover, y = proportion_points_with_PRAW, fill = landcover)) +
#   geom_bar(stat = "identity") +
#   labs(title = "Proportion of Points with PRAW Seen at Each Landcover Type",
#        x = "Landcover Type",
#        y = "Proportion of Points with PRAW") +
#   #scale_fill_grafify(palette = "fishy", labels = c("Mixed Pine/Hardwood (MPH)", "Openings (OP)", "Disturbed Areas (DA)","Even-Aged Pine (EAP)", "Uneven-aged Forested Wetland (UAW)", "Young Pine (YP)", "Unknown", "Uneven-aged Pine (UAP)")) +
# # scale_x_discrete(labels = c("MPH","OP","DA", "EAP","UAW", "YP", "Unknown", "UAP")) +
#   theme_minimal() +
#   theme(axis.text.x = element_text(angle = 45, hjust=1))


fig_PRAW <-  
ggplot(result, aes(x = landcover)) +
  geom_bar(aes(y = total_points, fill = "Total Points"), stat = "identity", position = "dodge") +
  geom_bar(aes(y = PRAW_points, fill = "Points with Target Species"), stat = "identity", position = "dodge") +
  labs(title = "Praire Warbler",
       x = "",
       y = "") +
  scale_fill_manual(name = "Legend",
                    values = c("Total Points" = "#F6A600", "Points with Target Species" = "darkblue"),
                    labels = c("Points with Target Species", "Total Points")) +
  scale_x_discrete(labels = c("MPH" = "Mixed Pine/Hardwood", "OP" = "Openings", "DA" = "Disturbed Areas", "EAP" = "Even Pine", "UAW" = "Uneven Forested Wetland", "YP" = "Young Pine", "NULL" = "Unknown", "UAP" = "Uneven Pine", "EAW" = "Even Wetland", "UAH" = "Uneven Hardwood", "YH" = "Young Hardwood")) +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(hjust = 0.5))
```

```{r}
#Make a figure combining all three target species on each type of landcover 
fig_combined <-
  ggarrange(fig_NOBO, fig_BACS, fig_PRAW,
          ncol = 1, 
          common.legend= T,
          legend = "right")

fig_combined <-  annotate_figure(fig_combined, left = text_grob("Points on Perdido River WMA", vjust = 0.8, rot = 90))

#ggsave("KylieBlake\\targetspecies_PR.jpeg", plot = fig_combined, device = "jpeg", width = 8, height = 15)

```

## All Species from 2024 Point Count Season

```{r}
#################################DATA MANIPULATION##########################################

################ WMA ##################

# Count occurrences of every species grouped by WMA
species_counts_wma <- merged_data %>%
  group_by(wma, species) %>%         # Group the data by WMA and species
  summarise(count = n(), .groups = "drop")  # Count the number of occurrences within each group
  #The .groups = "drop" argument tells dplyr to remove the grouping after summarization, i.e., drop the grouping structure.

# Print the species counts grouped by WMA
print(species_counts_wma)

###Species Richness###

# Calculate species richness (distinct species) for each WMA after removing species starting with "XX"
# Species starting with "XX" were not identified to the species-level
species_richness_wma <- merged_data %>%
  filter(!grepl("^XX", species)) %>%  # Exclude rows where species starts with "XX"
  group_by(wma) %>%                   # Group the data by WMA
  summarise(richness = n_distinct(species), .groups = "drop")  # Count distinct species within each WMA group
#grepl() is a function that returns a logical vector (TRUE or FALSE) based on whether a pattern is found in a character vector.
#grepl("^XX", species) looks for rows in the species column that start with "XX".

#To put the species richness in descending order by WMA
species_richness_wma <-  species_richness_wma %>% 
  mutate(wma = factor(wma, levels = unique(wma[order(-richness)])))

# Print the species richness for each WMA
print(species_richness_wma)

#################################FIGURES##########################################

fig_speciesrich <-  
  ggplot(species_richness_wma, aes(x= wma, y=richness, fill = ifelse(wma == "PR", "highlight", "normal")))+
  geom_bar(stat = "identity", position = "dodge")+
  labs(y = "",
       x = "") +
  scale_fill_manual(name = "Legend",
                    values = c("highlight" = "#BE0032", "normal" = "#848482"),
                    labels = c("Perdido River", "Other WMAs")) +
  scale_x_discrete(labels = c("AU" = "Autauga", "BA" = "Barbour", "FH" = "Freedom Hills", "FS" = "Fred T. Stimpson", "LA" = "Lauderdale", "PR" = "Perdido River", "RH" = "Red Hills", "SK" = "Skyline", "US" = "Upper State")) +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
#ggsave("KylieBlake\\speciesrichness.jpeg", plot = fig_speciesrich, device = "jpeg", width = 8, height = 6)

# Landcover across WMAs
landcover <- merged_data %>% 
  group_by(landcover) %>% 
  summarise(count = n_distinct(pointId2)) %>%  # calculates the number of distinct values in the pointId2 column for each landcover group and stores this count in a new column named count. 
  filter(landcover != "NULL") %>%
   mutate(percentage = count / sum(count) * 100) #converting to percent of each landcover
landcover
library(ggrepel)


kellyPalette <- c("#F3C300","#875692", "#A1CAF1","#BE0032","#C2B280","#848482","#E68FAC","#008856","#0067A5","#F99379", "#604E97", "#F6A600", "#B3446C")

pie_landcover <-
  ggplot(landcover, aes(x = "", y = count, fill = landcover)) +
  geom_bar(stat = "identity", width = 1) +
  coord_polar("y", start = 0) +
  scale_fill_manual(values = kellyPalette,
                    name = "Landcover Types",
                    labels = c("AL" = "Agricultural Land (AL)",
                               "DA" = "Disturbed Areas (DA)",
                               "EAH" ="Even-Aged Hardwood (EAH)",
                               "EAP" = "Even-Aged Pine (EAP)",
                               "EAW" = "Even-Aged Wetland (EAW)",
                               "MPH" = "Mixed Pine/Hardwood (MPH)",
                               "OP" = "Openings (OP)",
                               "UAH" = "Uneven-Aged Hardwood (UAH)" ,
                               "UAP" = "Uneven-Aged Pine (UAP)",
                               "UAW" ="Uneven-Aged Wetland (UAW)",
                               "YH" = "Young Hardwood (YH)",
                               "YP" = "Young Pine (YP)")) +
  theme_void() +
  theme(plot.title = element_text(hjust = 0.5))+
  labs(title = "Landcover Distribution Across Wilidlife Management Areas")+
    geom_label_repel(aes(label = paste0(round(percentage, 1), "%")),
                   position = position_stack(vjust = 0.5),
                   box.padding = 0.5,
                   point.padding = 0.5,
                   segment.color = "grey50")
#ggsave("KylieBlake\\landcover_distribution.jpeg", plot = pie_landcover, device = "jpeg", width = 8, height = 6)

```

```{r}
#---------------------------------MAKE A POINT COUNT MAP-------------------------------------------------------------#
######GO BACK INTO DATA AND FILTER BY MIS-IDS########################

#load in packages
library(ggplot2)
library(sf)
library(rnaturalearth)
library(dplyr)
library(devtools)
devtools::install_github("ropensci/rnaturalearthhires") #calls in border of Alabama 

#load in map of Alabama
alabama <- ne_states(country = "United States of America", returnclass = "sf") %>%
  filter(name == "Alabama")

#make data frame to use
pointcount_data <- merged_data %>% 
  filter(species %in% c("NOBO", "BACS", "AMKE","PRAW")) %>% 
  group_by(species, wma, landcover,latitudeWGS84,longitudeWGS84) %>% 
  summarise(count = n(),.groups= "drop")

#Alabama Map - Species by WMA 
ggplot() +
  geom_sf(data = alabama, fill = "lightblue",alpha =0.5, color = "black") + # Alabama boundary
  geom_point(
    data = pointcount_data,
    aes(x = longitudeWGS84, y = latitudeWGS84, color = species),
    shape=20,
    size = 5,
    alpha = 0.5
  ) +
  scale_color_manual(values = c("AMKE" = "red", "NOBO" = "blue", "BACS" = "green","PRAW"="yellow")) +
  labs(
    title = "Point Count Map by Species",
    x = "Longitude",
    y = "Latitude",
    color = "Species"
  ) +
  theme_minimal()
```

```{r}
#------------------------------------Help me determine species --------------------------------------------------------------
# Count species occurrences and sort them from greatest to least
species_abundance <- merged_data %>%
  group_by(species) %>%           # Group by species
  summarise(count = n()) %>%      # Count occurrences
  arrange(desc(count))            # Sort by count in descending order

# View the result
print(species_abundance)

#----------------------------------- Highest count of target species  by WMA ----------------------------------
# Filter the dataset for the desired species
desired_species <- c("NOBO", "BACS")

# Calculate the wma with highest sum of desired target species
max_desiredspecies_wma <- merged_data %>%
  group_by(wma) %>%                               # Group by WMA
  summarise(desired_count = sum(species %in% desired_species)) %>% 
  arrange(desc(desired_count)) 

max_desiredspecies_landcover <- merged_data %>%
  group_by(landcover) %>%                               # Group by WMA
  summarise(desired_count = sum(species %in% desired_species)) %>% 
  arrange(desc(desired_count)) 

################# TESTING SPECIES SUITABILITY ############################################
# Pre-determined species
pre_determined_species <- c("NOBO", "BACS")

# Find WMAs with at least two pre-determined species
wma_with_target_species <- merged_data %>%
  filter(species %in% pre_determined_species) %>% #filter by nobo and bacs
  group_by(wma) %>% 
  summarise(target_species_count = n_distinct(species)) %>% #get a count of target species 
  filter(target_species_count >= 2) %>% #include ones where only greater or equal to 2
  pull(wma) #only extract info about one column (wma) 

print(wma_with_target_species) #WMA with target species = Fred T. Simpson (FS), Perdido River (PR)

#Assess non-abundant species in selected WMAs -- analyze species within these WMAs to identify candidates for inclusion based on abundance

allspecies_counts <- merged_data %>%
  filter(wma %in% wma_with_target_species) %>%
  group_by(species,wma) %>%
  summarise(total_count = n()) %>%
  arrange(total_count) #Sort by abundance (least to most)


#------------------------Evaluate Habitat Suitability for Target Species--------------------------------------

# Analyze species counts by landcover in target WMAs
allspecies_by_landcover <- merged_data %>%
  filter(wma %in% wma_with_target_species) %>%
  group_by(species, landcover) %>%
  summarise(total_count = n()) %>%
  arrange(desc(total_count))


#Combine Criteria (habitat suitability, WMAs with target species, not overly abundant but with potential response)

allspecies_by_landcover_Wma <- merged_data %>%
  filter(wma %in% wma_with_target_species) %>%
  group_by(species,landcover,wma) %>%
  summarise(total_count = n()) %>%
  arrange(desc(total_count))

######################Put merged data into shape file#######################################
# Load required libraries

library(sf)

# Check the column names
print(colnames(merged_data))

# Ensure 'longitudeWGS84' and 'latitudeWGS84' are numeric
merged_data$longitudeWGS84 <- as.numeric(merged_data$longitudeWGS84)
merged_data$latitudeWGS84 <- as.numeric(merged_data$latitudeWGS84)

# Check for NAs
print(sum(is.na(merged_data$longitudeWGS84)))
print(sum(is.na(merged_data$latitudeWGS84)))

# Convert to an sf object (Simple Features)
WMAshapefile_data <- st_as_sf(merged_data, coords = c("longitudeWGS84", "latitudeWGS84"), crs = 4326)

# Check if the conversion was successful
print(WMAshapefile_data)

plot(WMAshapefile_data["geometry"])

# Save as a shapefile
st_write(WMAshapefile_data, "C:/Users/kzb0180/OneDrive - Auburn University/ValenteGitHub/ICP/Kylie Blake/WMAdata.shp", driver = "ESRI Shapefile")
```

```{r}
######################Calculate Stats on WMAs#############################
#From A to B we sampled C point count stations, recording D total individuals of E different species. The most common species were F, G, and H (report proportion of sites each species were detected per point).

#Figure out number of point count stations 



merged_data %>%
  filter(!grepl("^XX", species)) %>% 
  group_by(individualId, pointId2,species) %>% 
  summarise(count=n_distinct(species))


#filter out XX species
unique_species <- merged_data %>%
  filter(!grepl("^XX", species))
#grepl() is a function that returns a logical vector (TRUE or FALSE) based on whether a pattern is found in a character vector.
#grepl("^XX", species) looks for rows in the species column that start with "XX".

unique_species <- merged_data %>% 
  group_by(species) %>% 
  summarise(total_count = sum(count), .groups = "drop")

unique_sites <- merged_data %>% 
  distinct(pointId2) %>% 
  summarise(count(pointId2))



#calculate proportion of unique species 
#sum of total individuals seen / sum of total points (603)
# Proportion_species <- unique_species %>%
#   distinct(individualId)
#   count(distinct(species), name = "num_species") %>%  # Count species total
#   mutate(proportion = num_species / n_distinct(merged_data$pointId2)) %>%  # Divide by total unique sites
#   arrange(desc(proportion))

species_abundance <- unique_species %>% #calculates species abundance without unknown species
  count(species, name = "count") %>%
  arrange(desc(count))

species_abundance %>%  #sums up the count column to calculate the total birds seen of the 104 species 
  summarise(total=sum(count))

#something is wrpng with calculating proportion Idk how to fix brain is tired
# Calculate Proportions: For each species, divide the total number of individuals by the overall total number of individuals across all species and locations.


species_wma <- merged_data %>%
  filter(species %in% c("NOBO", "PRAW", "BACS"), wma== "PR") %>%   # Remove possible duplicate detections within the same site
  group_by(species) %>% 
  summarise(count = n_distinct(pointId2,individualId))

#Define list of AOU codes of SGCN to search
SGCN <- c("MODU","ABDU", "WOST","REEG","LEBI", "GOEA", "STKI", "YERA", "BLRA", "KIRA", "AMOY", "PIPL", "SNPL",
          "WIPL", "REKN", "GBTE", "SEOW", "AMKE", "RCWO", "LOSH", "CORA","BEWR","CERW","HESP", "SESP", "NSTS", "BACS", "RUBL") #excluded Ivory-billed because it is extinct)

#Count occurences of each SGCN species in the dataset
SGCNcount <- merged_data %>% 
 filter(species %in% SGCN) %>% 
  count(species, name= "count") %>% 
  right_join(data.frame(species = SGCN), by= "species") %>% 
  mutate(count=ifelse(is.na(count),NA,count)) #for species not existant in merged_data, insert NA 

print(SGCNcount)

#Species of Conservation Need Table
SGCN_counts <- merged_data %>% 
  filter(species %in% c("CEDW", "BACS", "AMKE")) %>% 
  group_by(species) %>% 
  summarise(count = n_distinct(individualId)) #Count the number of unique individals seen for each target
```


